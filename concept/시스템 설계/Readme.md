## 📕 시스템 설계의 기본
### 웹 서버, 데이터베이스 분산 (마스터(쓰기), 슬레이브(읽기))
### 캐시 (웹 서버 ← 캐시 ← 데이터베이스)

### 콘텐츠 전송 네트워크 (CDN)
클라이언트가 접속하는 가장 가까운 `CDN 서버`가 콘텐츠를 전달하게 되는 방식

1. CDN 서버에 콘텐츠가 없다면 원본 서버로 부터 가져온다. 그 콘텐츠를 CDN 서버에 저장한다. URL 도메인은 CDN 사업자가 제공한다.
ex) 클라우드 프론트 `https://site.cloudfront.net/logo.png` 아카마이 `https://site.akamai.com/image-manager/img/logo.png`

2. CDN 서버의 캐시에 해당 이미지가 없는 경우 서버는 원본(Origin) 서버에 요청하여 파일을 가져온다. 원본 서버는 웹 서버 일 수도, 아마존 S3와 같은 온라인 저장소일 수도 있다.
3. 원본 서버가 파일을 CDN 서버에 반환한다. 응답 HTTP 헤더에는 캐시 기간을 설명하는 `TTL(Time-To-Live)` 값이 들어 있다.
4. CDN 서버는 파일을 캐시하고 사용자 A에게 반환한다. 이미지는 TTL에 명시된 시간이 끝날 때까지 캐시된다.
5. 사용자가 B가 같은 이미지에 대한 요청을 CDN 서버에 요청한다.
6. 만료되지 않은 이미지에 대한 요청은 캐시를 통해 처리된다.

### ❗️ CDN 사용 시 고려 사항
- 비용: CDN은 보통 제3 사업자에 의해 운영되며, 데이터 전송 양에 따라 요금을 내게 된다. 자주 사용되지 않는 콘텐츠를 캐싱하는 것은 비효율적이다.
- 적절한 만료시간: 너무 길지도 짧지도 않아야 하는데, 길면 콘텐츠의 신선도는 떨어질 것이고, 짧으면 원본 서버에 접속하는 일이 자주 발생하니 비즈니스에 맞게 조절한다.
- CDN 장애 대처 방안: CDN 서버의 장애를 대비하여 원본 서버에서도 가져 올 수 있도록 구성하는 것이 필요할 수도 있다.
- 콘텐츠 무효화: 아직 만료되지 않은 콘텐츠라 하더라도 이미지 변경이나, 수정이 일어 날 수 있다. 이 경우 CDN 서비스 사업자가 제공하는 API를 이용하여 콘텐츠 무효화 한다. 또는 새로운 버전을 지정하기 위해서는 URL 마지막에 버전 번호를 인자로 주면 된다. `image.png?v=2` 와 같은 식이다.

### 메시지 큐
시스템을 더 큰 규모로 확장하기 위해서는 시스템의 컴포넌트를 분리하여, 독립적으로 확장될 수 있도록 하여야 한다. `메시지 큐`는 실제 분산 시스템이 이 문제를 풀기 위해 채용하고 있는 핵심전 전략 중 하나이다.

*생산자 →(발행) *메시지큐 →(소비), ←(구독) *소비자

### 메트릭
메트릭을 잘 수집하면 사업 현황에 관한 유용한 정보를 얻을 수도 있고, 현재 상태를 손 쉽게 파악할 수도 있다.

- 호스트 단위 메트릭: CPU, 메모리, 디스크 I/O
- 종합 메트릭: 데이터베이스 계층의 성능, 캐시 계층의 성능
- 핵심 비즈니스 메트릭: 일별 능동 사용자, 수익, 재방문 등

자동화: 시스템이 크고 복잡해지면 생산성을 높이기 위해 자동화 도구를 활용해야 한다. 가령 지속적 통합 CI/CD 도구를 활용하면 개발자가 만드는 코드가 어떤 검증 절차를 자동으로 거치도록 할 수 있어서 문제를 쉽게 감지 할 수 있다. 이 외에도 빌드, 테스트, 배포 등의 절차를 자동화할 수 있어서 개발 생산성을 크게 향상 시킬 수 있다.

### 지금까지 내용의 설계
![KakaoTalk_Photo_2023-09-07-12-49-42](https://github.com/conf312/concept-description/assets/13326651/e3ff61d1-01ef-42da-9517-0c64ddb61b7e)


## 📕 데이터베이스의 확장
### 수직적 확장
고성능의 자원을 증설하는 방법으로 대상의 스펙을 증가 시킨다. 스택 오버플로는 2013년 한해 천만명 사용자를 한 대의 마스터 데이터베이스로 처리했다고 한다.

### 문제점
- 하드웨어에는 한계가 있으므로 CPU, RAM 등을 무한 증설할 수없다.
- SPOF(Single Point of Failure)로 인한 위험성이 크다.
- 비용이 많이 든다.

### 수평적 확장
흔히 데이터베이스의 수평적 확장은 샤딩(Sharding) 이라고도 부르는데, 더 많은 서버를 추가함으로써 성능을 향상 시킨다.


## 📕 처리율 제한 장치의 설계
네트워크 시스템에서 처리율 제한 장치는 클라이언트 또는 서비스가 보내는 트래픽의 처리율(Rate)을 제어하기 위한 장치이다.

### 몇 가지 사례
- 사용자는 초당 2회 이상 새 글을 올릴 수 없다.
- 같은 IP 주소로는 하루에 10개 이상의 계정을 생성할 수 없다.
- 같은 디바이스로는 주당 5회 이상 리워드를 요청할 수 없다.

### 장점
- DoS(Denial of Service) 공격에 의한 자원 고갈을 방지할 수 있다. (대형 IT 기업들이 공개한 거의 대부분의 API는 어떤 형태로든 처리율 제한 장치를 갖고 있다.)
- 비용을 절감한다.
- 서버 과부하를 막는다. (봇에서 오는 트래픽이나 사용자의 잘못된 이용 패턴으로 유발된 트래픽을 걸러내는데 사용할 수 있다.)

### 처리율 제한을 클라이언트에 둔다면
- 클라이언트 요청은 쉽게 위변조가 가능해서 모든 상황을 통제하는 것은 어려울 수 있다.

### 처리율 제한을 서버측에 둔다면
- 클라이언트와 API 서버 사이에 `미들웨어`로 하여금 API 서버로 가는 요청을 통제하도록 한다.
- 마이크로서비스의 경우 처리율 제한 장치는 보통 `API 게이트웨이`라 불리는 컴포넌트에 구현된다.

### 처리율 제한 알고리즘의 종류
- 토큰 버킷(token bucket)
- 누출 버킷(leaky bucket)
- 고정 윈도 카운터(fixed window counter)
- 이동 윈도 로그(sliding window log)
- 이동 윈도 카운터(sliding window counter)

### 토큰 버킷(token bucket) 알고리즘 (아마존, 스트라이프)
지정된 용량을 갖는 컨테이너로 사전 설정된 양의 토큰이 주기적으로 채워진다. `토큰이 꽉 찬 버킷에는 더 이상 토큰은 추가되지 않는다.` `각 요청은 처리될 때마다 하나의 토큰을 사용`한다. `충분한 토큰이 없는 경우`, 해당 요청은 버려진다.

### 누출 버킷(leaky bucket) 알고리즘 (쇼피파이)
토큰 버킷 알고리즘과 비슷하지만 요청 처리율이 고정되어 있다는 점이 다르다. 보통 FIFO 큐로 구현한다. 

#### 동작원리
- 요청이 도착하면 큐가 가득 차 있는지 본다. 빈자리가 있는 경우에는 큐에 요청을 추가한다.
- 큐가 가득 차 있는 경우에는 새 요청은 버린다.
- 지정된 시간마다 큐에서 요청을 꺼내어 처리한다.

#### 두 인자의 사용
- 버킷 크기: 큐 사이즈와 같은 값으로 큐에는 처리될 항목들이 보관된다.
- 처리율(outflow rate): 지정된 시간당 몇 개의 항목을 처리할지 지정하는 값이다. 보통 `초 단위`로 표현된다.

#### 장점
- 큐의 크기가 제한되어 있어 메모리 사용량 측면에서 효율적이다.
- 고정된 처리율을 갖고 있기 때문에 안정적 출력이 필요한 경우 적합하다.

#### 단점
- 단시간에 많은 트래픽이 몰리는 경우 큐에는 오래된 요청들이 쌓이게 되고, 그 요청들을 제때 처리 못하면 최신 요청들은 버리게 된다.
- 두 개 인자를 가지고 있는데, 이들을 올바르게 튜닝하기가 까다로울 수 있다.






















### 출처
- 대규모 시스템 설계 기초
